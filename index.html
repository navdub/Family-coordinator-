<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Activity Coordinator</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<!-- Google Calendar API -->
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
    
<script src="config.js"></script>
<script src="calendar-functions.js"></script>
    
    <!-- API Service - All backend calls -->
    <script src="services/api.js"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        // Initialize Firebase with config
        firebase.initializeApp(APP_CONFIG.FIREBASE_CONFIG);
        const db = firebase.firestore();

        function LoginScreen({ onLogin }) {
            const [code, setCode] = useState('');
            const [name, setName] = useState('');
            const [isNew, setIsNew] = useState(false);
            const [err, setErr] = useState('');

            const login = async () => {
                if (!code) return setErr('Enter code');
                try {
                    const doc = await db.collection('families').doc(code.toUpperCase()).get();
                    if (doc.exists) onLogin(code.toUpperCase(), doc.data().name);
                    else setErr('Code not found');
                } catch (e) { setErr('Error: ' + e.message); }
            };

            const create = async () => {
                if (!name) return setErr('Enter name');
                const newCode = Math.random().toString(36).substring(2, 10).toUpperCase();
                try {
                    await db.collection('families').doc(newCode).set({ name, createdAt: new Date() });
                    onLogin(newCode, name);
                } catch (e) { setErr('Error: ' + e.message); }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                        <h1 className="text-3xl font-bold text-center mb-6">Family Activity Tracker</h1>
                        {err && <div className="bg-red-100 text-red-700 p-3 rounded mb-4">{err}</div>}
                        {!isNew ? (
                            <>
                                <input value={code} onChange={e => setCode(e.target.value.toUpperCase())} placeholder="Family Code" className="w-full px-4 py-3 border rounded-lg mb-4 uppercase" />
                                <button onClick={login} className="w-full bg-purple-600 text-white py-3 rounded-lg mb-3">Login</button>
                                <button onClick={() => setIsNew(true)} className="text-purple-600">Create Family →</button>
                            </>
                        ) : (
                            <>
                                <input value={name} onChange={e => setName(e.target.value)} placeholder="Family Name" className="w-full px-4 py-3 border rounded-lg mb-4" />
                                <button onClick={create} className="w-full bg-green-600 text-white py-3 rounded-lg mb-3">Create</button>
                                <button onClick={() => setIsNew(false)} className="text-gray-600">← Back</button>
                            </>
                        )}
                    </div>
                </div>
            );
        }

        function App() {
            const [code, setCode] = useState(localStorage.getItem('familyCode'));
            const [name, setName] = useState(localStorage.getItem('familyName'));
            const [kids, setKids] = useState([]);
            const [acts, setActs] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showKid, setShowKid] = useState(false);
            const [showAct, setShowAct] = useState(false);
            const [showCode, setShowCode] = useState(false);
            const [showPast, setShowPast] = useState(false);
            const [showNL, setShowNL] = useState(true);
            const [showRecommend, setShowRecommend] = useState(false);
            const [editAct, setEditAct] = useState(null);
            const [view, setView] = useState('calendar'); // Changed default to calendar
            const [mainView, setMainView] = useState('activities');
            const [groupBy, setGroupBy] = useState('none');
            const [expandedGroups, setExpandedGroups] = useState({});
            const [expandedActivities, setExpandedActivities] = useState({});
            const [showOtherWeeks, setShowOtherWeeks] = useState(false); // For collapsing other weeks
            const [newKid, setNewKid] = useState({ name: '', color: '#4ECDC4' });
            const [newAct, setNewAct] = useState({ 
                title: '', date: '', time: '', location: '', parent: 'Mom', kidId: '', 
                type: 'Pick Up', activityCategory: 'Physical', notes: '', notify: false, createdBy: 'Parent' 
            });
            const [nlInput, setNlInput] = useState('');
            const [nlLoading, setNlLoading] = useState(false);
            const [nlResult, setNlResult] = useState(null);
            const [recommendations, setRecommendations] = useState([]);
            const [recLoading, setRecLoading] = useState(false);

            useEffect(() => {
                if (!code) return;
                const unsub = db.collection('families').doc(code).collection('kids').onSnapshot(snap => {
                    setKids(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                });
                return unsub;
            }, [code]);

            useEffect(() => {
                if (!code) return;
                const unsub = db.collection('families').doc(code).collection('activities').onSnapshot(snap => {
                    setActs(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                    setLoading(false);
                });
                return unsub;
            }, [code]);

            const addKid = async () => {
                if (!newKid.name) return;
                await db.collection('families').doc(code).collection('kids').add(newKid);
                setNewKid({ name: '', color: '#4ECDC4' });
                setShowKid(false);
            };

            const addAct = async () => {
                if (!newAct.title || !newAct.date || !newAct.kidId) return;
                await db.collection('families').doc(code).collection('activities').add(newAct);
                setNewAct({ 
                    title: '', date: '', time: '', location: '', parent: 'Mom', kidId: '', 
                    type: 'Pick Up', activityCategory: 'Physical', notes: '', notify: false, createdBy: 'Parent' 
                });
                setShowAct(false);
            };

            const delKid = async id => {
                if (confirm('Delete this kid and all activities?')) {
                    await db.collection('families').doc(code).collection('kids').doc(id).delete();
                    const actSnap = await db.collection('families').doc(code).collection('activities').where('kidId', '==', id).get();
                    actSnap.docs.forEach(d => d.ref.delete());
                }
            };

            const delAct = async id => {
                if (confirm('Delete activity?')) {
                    await db.collection('families').doc(code).collection('activities').doc(id).delete();
                }
            };

            const logout = () => {
                localStorage.removeItem('familyCode');
                localStorage.removeItem('familyName');
                setCode(null);
                setName(null);
            };

            const startEdit = (activity) => {
                setEditAct({ ...activity });
            };

            const saveEdit = async () => {
                if (!editAct.id) return;
                const { id, ...data } = editAct;
                await db.collection('families').doc(code).collection('activities').doc(id).update(data);
                setEditAct(null);
            };

            const cancelEdit = () => {
                setEditAct(null);
            };

            const toggleActivityExpanded = (activityId) => {
                setExpandedActivities(prev => ({
                    ...prev,
                    [activityId]: !prev[activityId]
                }));
            };

            const parseNL = async () => {
                if (!nlInput.trim()) return;
                setNlLoading(true);
                try {
                    const result = await window.parseActivity(nlInput);
                    setNlResult(result);
                } catch (error) {
                    alert('Error: ' + error.message);
                }
                setNlLoading(false);
            };

            const applyNL = () => {
                if (nlResult) {
                    setNewAct({ ...newAct, ...nlResult });
                    setNlInput('');
                    setNlResult(null);
                    setShowAct(true);
                }
            };

            const getRecommendations = async () => {
                setRecLoading(true);
                try {
                    const recs = await window.recommendActivities(kids, acts);
                    setRecommendations(recs);
                } catch (error) {
                    alert('Error: ' + error.message);
                }
                setRecLoading(false);
            };

            const getPrepTasks = async (activityId) => {
                const activity = acts.find(a => a.id === activityId);
                if (!activity) return;
                
                try {
                    const tasks = await window.suggestPrepTasks(activity);
                    await db.collection('families').doc(code).collection('activities').doc(activityId).update({
                        prepTasks: tasks
                    });
                } catch (error) {
                    alert('Error getting prep tasks: ' + error.message);
                }
            };

            // Helper function to get start of week (Monday)
            const getWeekStart = (date) => {
                const d = new Date(date);
                const day = d.getDay();
                const diff = d.getDate() - day + (day === 0 ? -6 : 1);
                return new Date(d.setDate(diff));
            };

            // Helper function to get week range string
            const getWeekRange = (weekStart) => {
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);
                const formatDate = (d) => {
                    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    return `${months[d.getMonth()]} ${d.getDate()}`;
                };
                return `${formatDate(weekStart)} - ${formatDate(weekEnd)}`;
            };

            // Group activities by week
            const getActivitiesByWeek = () => {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const currentWeekStart = getWeekStart(today);
                
                const weekMap = {};
                
                acts.forEach(act => {
                    const actDate = new Date(act.date);
                    const weekStart = getWeekStart(actDate);
                    const weekKey = weekStart.toISOString().split('T')[0];
                    
                    if (!weekMap[weekKey]) {
                        weekMap[weekKey] = {
                            weekStart,
                            activities: [],
                            isCurrent: weekStart.getTime() === currentWeekStart.getTime()
                        };
                    }
                    weekMap[weekKey].activities.push(act);
                });

                // Sort weeks
                const sortedWeeks = Object.values(weekMap).sort((a, b) => 
                    a.weekStart.getTime() - b.weekStart.getTime()
                );

                return sortedWeeks;
            };

            // Get activities for a specific day
            const getActivitiesForDay = (date, activities) => {
                const dateStr = date.toISOString().split('T')[0];
                return activities.filter(act => act.date === dateStr).sort((a, b) => {
                    if (!a.time) return 1;
                    if (!b.time) return -1;
                    return a.time.localeCompare(b.time);
                });
            };

            if (!code) return <LoginScreen onLogin={(c, n) => { setCode(c); setName(n); localStorage.setItem('familyCode', c); localStorage.setItem('familyName', n); }} />;

            const todayActs = acts.filter(a => a.date === new Date().toISOString().split('T')[0]);
            const upcomingActs = acts.filter(a => a.date > new Date().toISOString().split('T')[0]);

            return (
                <div className="min-h-screen bg-gray-50">
                    <div className="bg-gradient-to-r from-purple-600 to-blue-500 text-white shadow-lg">
                        <div className="max-w-6xl mx-auto px-6 py-6">
                            <div className="flex justify-between items-center">
                                <div>
                                    <h1 className="text-3xl font-bold">{name} Activities</h1>
                                    <p className="text-purple-100">Code: {code}</p>
                                </div>
                                <button onClick={logout} className="bg-white text-purple-600 px-4 py-2 rounded-lg font-semibold">Logout</button>
                            </div>
                        </div>
                    </div>

                    <div className="max-w-6xl mx-auto p-6">
                        {/* Main Navigation Tabs */}
                        <div className="flex gap-4 mb-6">
                            <button onClick={() => setMainView('activities')} className={`px-6 py-3 rounded-lg font-semibold ${mainView === 'activities' ? 'bg-purple-600 text-white' : 'bg-white text-gray-700'}`}>
                                📅 Activities
                            </button>
                            <button onClick={() => setMainView('kids')} className={`px-6 py-3 rounded-lg font-semibold ${mainView === 'kids' ? 'bg-purple-600 text-white' : 'bg-white text-gray-700'}`}>
                                👶 Kids
                            </button>
                        </div>

                        {mainView === 'kids' ? (
                            <div className="bg-white rounded-xl shadow-md p-6">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-2xl font-bold">Kids</h2>
                                    <button onClick={() => setShowKid(!showKid)} className="bg-green-500 text-white px-4 py-2 rounded-lg">+ Add Kid</button>
                                </div>

                                {showKid && (
                                    <div className="mb-6 p-4 border-2 border-green-200 rounded-lg bg-green-50">
                                        <h3 className="font-bold mb-2">New Kid</h3>
                                        <div className="flex gap-2">
                                            <input value={newKid.name} onChange={e => setNewKid({ ...newKid, name: e.target.value })} placeholder="Name" className="flex-1 px-4 py-2 border rounded" />
                                            <input type="color" value={newKid.color} onChange={e => setNewKid({ ...newKid, color: e.target.value })} className="w-16 h-10" />
                                            <button onClick={addKid} className="bg-green-500 text-white px-4 py-2 rounded">Add</button>
                                        </div>
                                    </div>
                                )}

                                <div className="space-y-4">
                                    {kids.map(k => (
                                        <div key={k.id} className="p-4 border-2 rounded-lg flex justify-between items-center" style={{ borderColor: k.color }}>
                                            <div className="flex items-center gap-3">
                                                <div className="w-12 h-12 rounded-full" style={{ backgroundColor: k.color }}></div>
                                                <span className="text-xl font-bold">{k.name}</span>
                                            </div>
                                            <button onClick={() => delKid(k.id)} className="text-red-500 text-2xl">×</button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ) : (
                            <div>
                                {/* Ask Section */}
                                <div className="mb-6 bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl shadow-md p-6 border-2 border-blue-200">
                                    <button onClick={() => setShowNL(!showNL)} className="text-xl font-bold mb-4 flex items-center gap-2 w-full">
                                        <span>{showNL ? '▼' : '▶'}</span>
                                        <span>🤖 Ask me to add activities</span>
                                    </button>
                                    
                                    {showNL && (
                                        <div className="space-y-4">
                                            <div>
                                                <p className="text-sm text-gray-600 mb-2">Try: "Soccer practice for Alex tomorrow at 3pm at City Field"</p>
                                                <div className="flex gap-2">
                                                    <input 
                                                        value={nlInput} 
                                                        onChange={e => setNlInput(e.target.value)} 
                                                        placeholder="Describe the activity..." 
                                                        className="flex-1 px-4 py-3 border-2 border-blue-300 rounded-lg"
                                                        onKeyPress={e => e.key === 'Enter' && parseNL()}
                                                    />
                                                    <button onClick={parseNL} disabled={nlLoading} className="bg-blue-500 text-white px-6 py-3 rounded-lg font-semibold disabled:bg-gray-300">
                                                        {nlLoading ? '...' : 'Parse'}
                                                    </button>
                                                </div>
                                            </div>

                                            {nlResult && (
                                                <div className="p-4 bg-white rounded-lg border-2 border-green-300">
                                                    <h4 className="font-bold text-green-700 mb-2">✓ Parsed Result:</h4>
                                                    <div className="text-sm space-y-1 mb-3">
                                                        <p><strong>Activity:</strong> {nlResult.title}</p>
                                                        <p><strong>Date:</strong> {nlResult.date}</p>
                                                        <p><strong>Time:</strong> {nlResult.time || 'Not specified'}</p>
                                                        <p><strong>Location:</strong> {nlResult.location || 'Not specified'}</p>
                                                    </div>
                                                    <button onClick={applyNL} className="bg-green-500 text-white px-4 py-2 rounded-lg">
                                                        ✓ Use This & Open Form
                                                    </button>
                                                </div>
                                            )}

                                            <div className="pt-4 border-t-2 border-blue-200">
                                                <button onClick={() => setShowRecommend(!showRecommend)} className="font-semibold text-blue-700 mb-2 flex items-center gap-2">
                                                    <span>{showRecommend ? '▼' : '▶'}</span>
                                                    <span>💡 Get Activity Recommendations</span>
                                                </button>
                                                
                                                {showRecommend && (
                                                    <div className="space-y-2">
                                                        <button onClick={getRecommendations} disabled={recLoading} className="bg-purple-500 text-white px-4 py-2 rounded-lg disabled:bg-gray-300">
                                                            {recLoading ? 'Loading...' : 'Generate Recommendations'}
                                                        </button>
                                                        
                                                        {recommendations.length > 0 && (
                                                            <div className="space-y-2 mt-2">
                                                                {recommendations.map((rec, idx) => (
                                                                    <div key={idx} className="p-3 bg-white rounded border-l-4 border-purple-500">
                                                                        <p className="font-semibold">{rec.activity}</p>
                                                                        <p className="text-sm text-gray-600">{rec.reason}</p>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* Activities Section */}
                                <div className="bg-white rounded-xl shadow-md p-6">
                                    <div className="flex justify-between items-center mb-6">
                                        <h2 className="text-2xl font-bold">Activities</h2>
                                        <div className="flex gap-2">
                                            <button onClick={() => setView('list')} className={`px-4 py-2 rounded ${view === 'list' ? 'bg-purple-600 text-white' : 'bg-gray-200'}`}>
                                                📋 List
                                            </button>
                                            <button onClick={() => setView('calendar')} className={`px-4 py-2 rounded ${view === 'calendar' ? 'bg-purple-600 text-white' : 'bg-gray-200'}`}>
                                                📅 Calendar
                                            </button>
                                            <button onClick={() => setShowAct(!showAct)} className="bg-blue-500 text-white px-4 py-2 rounded-lg">+ Add Activity</button>
                                        </div>
                                    </div>

                                    {showAct && (
                                        <div className="mb-6 p-4 border-2 border-blue-200 rounded-lg bg-blue-50">
                                            <h3 className="font-bold mb-2">New Activity</h3>
                                            <div className="grid grid-cols-2 gap-2 mb-2">
                                                <input value={newAct.title} onChange={e => setNewAct({ ...newAct, title: e.target.value })} placeholder="Activity" className="px-4 py-2 border rounded" />
                                                <select value={newAct.kidId} onChange={e => setNewAct({ ...newAct, kidId: e.target.value })} className="px-4 py-2 border rounded">
                                                    <option value="">Select Kid</option>
                                                    {kids.map(k => <option key={k.id} value={k.id}>{k.name}</option>)}
                                                </select>
                                                <input type="date" value={newAct.date} onChange={e => setNewAct({ ...newAct, date: e.target.value })} className="px-4 py-2 border rounded" />
                                                <input type="time" value={newAct.time} onChange={e => setNewAct({ ...newAct, time: e.target.value })} className="px-4 py-2 border rounded" />
                                                <input value={newAct.location} onChange={e => setNewAct({ ...newAct, location: e.target.value })} placeholder="Location" className="px-4 py-2 border rounded" />
                                                <select value={newAct.parent} onChange={e => setNewAct({ ...newAct, parent: e.target.value })} className="px-4 py-2 border rounded">
                                                    <option>Mom</option>
                                                    <option>Dad</option>
                                                    <option>Both</option>
                                                </select>
                                                <select value={newAct.type} onChange={e => setNewAct({ ...newAct, type: e.target.value })} className="px-4 py-2 border rounded">
                                                    <option>Pick Up</option>
                                                    <option>Drop Off</option>
                                                    <option>Other</option>
                                                </select>
                                                <select value={newAct.activityCategory} onChange={e => setNewAct({ ...newAct, activityCategory: e.target.value })} className="px-4 py-2 border rounded">
                                                    <option>Physical</option>
                                                    <option>Social</option>
                                                    <option>Creative</option>
                                                    <option>Academic</option>
                                                    <option>Other</option>
                                                </select>
                                            </div>
                                            <textarea value={newAct.notes} onChange={e => setNewAct({ ...newAct, notes: e.target.value })} placeholder="Notes (optional)" className="w-full px-4 py-2 border rounded mb-2" rows="2" />
                                            <div className="flex gap-2 items-center mb-2">
                                                <label className="flex items-center gap-2">
                                                    <input type="checkbox" checked={newAct.notify} onChange={e => setNewAct({ ...newAct, notify: e.target.checked })} />
                                                    <span>Notify me</span>
                                                </label>
                                            </div>
                                            <button onClick={addAct} className="bg-blue-500 text-white px-4 py-2 rounded">Add Activity</button>
                                        </div>
                                    )}

                                    {loading ? (
                                        <p className="text-center text-gray-500">Loading...</p>
                                    ) : view === 'calendar' ? (
                                        // Calendar View - Default
                                        <div className="space-y-6">
                                            {(() => {
                                                const weekGroups = getActivitiesByWeek();
                                                const currentWeek = weekGroups.find(w => w.isCurrent);
                                                const otherWeeks = weekGroups.filter(w => !w.isCurrent);

                                                return (
                                                    <>
                                                        {/* Current Week - Always Expanded */}
                                                        {currentWeek && (
                                                            <div className="border-2 border-purple-500 rounded-lg p-4 bg-purple-50">
                                                                <h3 className="text-xl font-bold mb-4 text-purple-700">
                                                                    📅 This Week ({getWeekRange(currentWeek.weekStart)})
                                                                </h3>
                                                                
                                                                <div className="grid grid-cols-7 gap-2">
                                                                    {['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].map((day, idx) => {
                                                                        const date = new Date(currentWeek.weekStart);
                                                                        date.setDate(date.getDate() + idx);
                                                                        const dayActivities = getActivitiesForDay(date, currentWeek.activities);
                                                                        const isToday = date.toDateString() === new Date().toDateString();

                                                                        return (
                                                                            <div key={idx} className={`p-2 rounded-lg min-h-32 ${isToday ? 'bg-yellow-100 border-2 border-yellow-400' : 'bg-white border border-gray-200'}`}>
                                                                                <div className="font-bold text-sm mb-2 text-center">
                                                                                    {day}
                                                                                    <div className="text-xs text-gray-600">{date.getDate()}</div>
                                                                                    {isToday && <div className="text-xs text-yellow-700 font-semibold">TODAY</div>}
                                                                                </div>
                                                                                
                                                                                <div className="space-y-1">
                                                                                    {dayActivities.map(a => {
                                                                                        const kid = kids.find(k => k.id === a.kidId);
                                                                                        const isExpanded = expandedActivities[a.id];
                                                                                        
                                                                                        return (
                                                                                            <div key={a.id} className="text-xs p-2 rounded bg-white shadow-sm border-l-4" style={{ borderLeftColor: kid?.color || '#ccc' }}>
                                                                                                {editAct?.id === a.id ? (
                                                                                                    // Edit mode
                                                                                                    <div className="space-y-2">
                                                                                                        <input value={editAct.title} onChange={e => setEditAct({ ...editAct, title: e.target.value })} className="w-full px-2 py-1 border rounded text-xs" />
                                                                                                        <input type="time" value={editAct.time} onChange={e => setEditAct({ ...editAct, time: e.target.value })} className="w-full px-2 py-1 border rounded text-xs" />
                                                                                                        <div className="flex gap-1">
                                                                                                            <button onClick={saveEdit} className="flex-1 px-2 py-1 bg-green-500 text-white rounded text-xs">Save</button>
                                                                                                            <button onClick={cancelEdit} className="flex-1 px-2 py-1 bg-gray-300 rounded text-xs">Cancel</button>
                                                                                                        </div>
                                                                                                    </div>
                                                                                                ) : (
                                                                                                    <>
                                                                                                        <div className="flex justify-between items-start mb-1">
                                                                                                            <button onClick={() => toggleActivityExpanded(a.id)} className="text-gray-500 text-xs">
                                                                                                                {isExpanded ? '▼' : '▶'}
                                                                                                            </button>
                                                                                                            <div className="flex gap-1">
                                                                                                                <button onClick={() => startEdit(a)} className="text-blue-500 hover:text-blue-700" title="Edit">✏️</button>
                                                                                                                <button onClick={() => delAct(a.id)} className="text-red-500 hover:text-red-700" title="Delete">×</button>
                                                                                                            </div>
                                                                                                        </div>
                                                                                                        <div className="font-semibold">{a.notify && '🔔 '}{a.title}</div>
                                                                                                        <div style={{ color: kid?.color }} className="font-semibold">{kid?.name}</div>
                                                                                                        <div className="text-gray-600">{a.time || 'No time'}</div>
                                                                                                        <div className="text-gray-600">{a.type}</div>
                                                                                                        
                                                                                                        {isExpanded && (
                                                                                                            <div className="mt-2 pt-2 border-t border-gray-200 space-y-1">
                                                                                                                <div><strong>Location:</strong> {a.location || 'N/A'}</div>
                                                                                                                <div><strong>Parent:</strong> {a.parent}</div>
                                                                                                                <div><strong>Category:</strong> {a.activityCategory}</div>
                                                                                                                {a.notes && <div><strong>Notes:</strong> {a.notes}</div>}
                                                                                                                {a.prepTasks?.length > 0 && (
                                                                                                                    <div>
                                                                                                                        <strong>Prep Tasks:</strong>
                                                                                                                        <ul className="list-disc ml-3 mt-1">
                                                                                                                            {a.prepTasks.map((task, idx) => <li key={idx}>{task}</li>)}
                                                                                                                        </ul>
                                                                                                                    </div>
                                                                                                                )}
                                                                                                                {(!a.prepTasks || a.prepTasks.length === 0) && (
                                                                                                                    <button onClick={() => getPrepTasks(a.id)} className="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded mt-1">
                                                                                                                        Get Prep Tasks
                                                                                                                    </button>
                                                                                                                )}
                                                                                                            </div>
                                                                                                        )}
                                                                                                    </>
                                                                                                )}
                                                                                            </div>
                                                                                        );
                                                                                    })}
                                                                                </div>
                                                                            </div>
                                                                        );
                                                                    })}
                                                                </div>
                                                            </div>
                                                        )}

                                                        {/* Other Weeks - Collapsible */}
                                                        {otherWeeks.length > 0 && (
                                                            <div className="border-2 border-gray-300 rounded-lg p-4 bg-gray-50">
                                                                <button 
                                                                    onClick={() => setShowOtherWeeks(!showOtherWeeks)}
                                                                    className="w-full text-left text-xl font-bold mb-2 flex items-center gap-2 text-gray-700"
                                                                >
                                                                    <span>{showOtherWeeks ? '▼' : '▶'}</span>
                                                                    <span>📆 See Other Weeks ({otherWeeks.length} weeks)</span>
                                                                </button>
                                                                
                                                                {showOtherWeeks && (
                                                                    <div className="space-y-6 mt-4">
                                                                        {otherWeeks.map((week, weekIdx) => (
                                                                            <div key={weekIdx} className="border border-gray-300 rounded-lg p-4 bg-white">
                                                                                <h4 className="text-lg font-bold mb-4 text-gray-700">
                                                                                    Week of {getWeekRange(week.weekStart)}
                                                                                </h4>
                                                                                
                                                                                <div className="grid grid-cols-7 gap-2">
                                                                                    {['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].map((day, idx) => {
                                                                                        const date = new Date(week.weekStart);
                                                                                        date.setDate(date.getDate() + idx);
                                                                                        const dayActivities = getActivitiesForDay(date, week.activities);

                                                                                        return (
                                                                                            <div key={idx} className="p-2 rounded-lg min-h-32 bg-gray-50 border border-gray-200">
                                                                                                <div className="font-bold text-sm mb-2 text-center">
                                                                                                    {day}
                                                                                                    <div className="text-xs text-gray-600">{date.getDate()}</div>
                                                                                                </div>
                                                                                                
                                                                                                <div className="space-y-1">
                                                                                                    {dayActivities.map(a => {
                                                                                                        const kid = kids.find(k => k.id === a.kidId);
                                                                                                        const isExpanded = expandedActivities[a.id];
                                                                                                        
                                                                                                        return (
                                                                                                            <div key={a.id} className="text-xs p-2 rounded bg-white shadow-sm border-l-4" style={{ borderLeftColor: kid?.color || '#ccc' }}>
                                                                                                                {editAct?.id === a.id ? (
                                                                                                                    <div className="space-y-2">
                                                                                                                        <input value={editAct.title} onChange={e => setEditAct({ ...editAct, title: e.target.value })} className="w-full px-2 py-1 border rounded text-xs" />
                                                                                                                        <input type="time" value={editAct.time} onChange={e => setEditAct({ ...editAct, time: e.target.value })} className="w-full px-2 py-1 border rounded text-xs" />
                                                                                                                        <div className="flex gap-1">
                                                                                                                            <button onClick={saveEdit} className="flex-1 px-2 py-1 bg-green-500 text-white rounded text-xs">Save</button>
                                                                                                                            <button onClick={cancelEdit} className="flex-1 px-2 py-1 bg-gray-300 rounded text-xs">Cancel</button>
                                                                                                                        </div>
                                                                                                                    </div>
                                                                                                                ) : (
                                                                                                                    <>
                                                                                                                        <div className="flex justify-between items-start mb-1">
                                                                                                                            <button onClick={() => toggleActivityExpanded(a.id)} className="text-gray-500 text-xs">
                                                                                                                                {isExpanded ? '▼' : '▶'}
                                                                                                                            </button>
                                                                                                                            <div className="flex gap-1">
                                                                                                                                <button onClick={() => startEdit(a)} className="text-blue-500 hover:text-blue-700" title="Edit">✏️</button>
                                                                                                                                <button onClick={() => delAct(a.id)} className="text-red-500 hover:text-red-700" title="Delete">×</button>
                                                                                                                            </div>
                                                                                                                        </div>
                                                                                                                        <div className="font-semibold">{a.notify && '🔔 '}{a.title}</div>
                                                                                                                        <div style={{ color: kid?.color }} className="font-semibold">{kid?.name}</div>
                                                                                                                        <div className="text-gray-600">{a.time || 'No time'}</div>
                                                                                                                        
                                                                                                                        {isExpanded && (
                                                                                                                            <div className="mt-2 pt-2 border-t border-gray-200 space-y-1">
                                                                                                                                <div><strong>Location:</strong> {a.location || 'N/A'}</div>
                                                                                                                                <div><strong>Parent:</strong> {a.parent}</div>
                                                                                                                                <div><strong>Category:</strong> {a.activityCategory}</div>
                                                                                                                                {a.notes && <div><strong>Notes:</strong> {a.notes}</div>}
                                                                                                                                {a.prepTasks?.length > 0 && (
                                                                                                                                    <div>
                                                                                                                                        <strong>Prep Tasks:</strong>
                                                                                                                                        <ul className="list-disc ml-3 mt-1">
                                                                                                                                            {a.prepTasks.map((task, idx) => <li key={idx}>{task}</li>)}
                                                                                                                                        </ul>
                                                                                                                                    </div>
                                                                                                                                )}
                                                                                                                            </div>
                                                                                                                        )}
                                                                                                                    </>
                                                                                                                )}
                                                                                                            </div>
                                                                                                        );
                                                                                                    })}
                                                                                                </div>
                                                                                            </div>
                                                                                        );
                                                                                    })}
                                                                                </div>
                                                                            </div>
                                                                        ))}
                                                                    </div>
                                                                )}
                                                            </div>
                                                        )}

                                                        {weekGroups.length === 0 && (
                                                            <p className="text-center text-gray-500 py-8">No activities scheduled</p>
                                                        )}
                                                    </>
                                                );
                                            })()}
                                        </div>
                                    ) : (
                                        // List View
                                        <div>
                                            <div className="mb-4 flex gap-2 items-center">
                                                <label className="font-semibold">Group by:</label>
                                                <select value={groupBy} onChange={e => setGroupBy(e.target.value)} className="px-4 py-2 border rounded">
                                                    <option value="none">None</option>
                                                    <option value="kid">Kid</option>
                                                    <option value="date">Date</option>
                                                    <option value="parent">Parent</option>
                                                </select>
                                                <label className="ml-4 flex items-center gap-2">
                                                    <input type="checkbox" checked={showPast} onChange={e => setShowPast(e.target.checked)} />
                                                    <span>Show past activities</span>
                                                </label>
                                            </div>

                                            {acts.length === 0 ? (
                                                <p className="text-center text-gray-500">No activities yet</p>
                                            ) : groupBy === 'none' ? (
                                                <div className="space-y-3">
                                                    {acts
                                                        .filter(a => showPast || a.date >= new Date().toISOString().split('T')[0])
                                                        .sort((a, b) => a.date.localeCompare(b.date) || (a.time || '').localeCompare(b.time || ''))
                                                        .map(a => {
                                                            const kid = kids.find(k => k.id === a.kidId);
                                                            const isExpanded = expandedActivities[a.id];
                                                            
                                                            return (
                                                                <div key={a.id} className="p-4 bg-gray-50 rounded-lg border-l-4" style={{ borderLeftColor: kid?.color || '#ccc' }}>
                                                                    {editAct?.id === a.id ? (
                                                                        <div className="space-y-2">
                                                                            <div className="grid grid-cols-3 gap-2">
                                                                                <input value={editAct.title} onChange={e => setEditAct({ ...editAct, title: e.target.value })} placeholder="Activity" className="px-4 py-2 border rounded" />
                                                                                <input type="date" value={editAct.date} onChange={e => setEditAct({ ...editAct, date: e.target.value })} className="px-4 py-2 border rounded" />
                                                                                <input type="time" value={editAct.time} onChange={e => setEditAct({ ...editAct, time: e.target.value })} className="px-4 py-2 border rounded" />
                                                                                <input value={editAct.location} onChange={e => setEditAct({ ...editAct, location: e.target.value })} placeholder="Location" className="px-4 py-2 border rounded" />
                                                                                <select value={editAct.parent} onChange={e => setEditAct({ ...editAct, parent: e.target.value })} className="px-4 py-2 border rounded">
                                                                                    <option>Mom</option>
                                                                                    <option>Dad</option>
                                                                                    <option>Both</option>
                                                                                </select>
                                                                                <select value={editAct.type} onChange={e => setEditAct({ ...editAct, type: e.target.value })} className="px-4 py-2 border rounded">
                                                                                    <option>Pick Up</option>
                                                                                    <option>Drop Off</option>
                                                                                    <option>Other</option>
                                                                                </select>
                                                                            </div>
                                                                            <textarea value={editAct.notes} onChange={e => setEditAct({ ...editAct, notes: e.target.value })} placeholder="Notes" className="w-full px-4 py-2 border rounded" rows="2" />
                                                                            <div className="flex gap-2">
                                                                                <button onClick={saveEdit} className="px-4 py-2 bg-green-500 text-white rounded">💾 Save</button>
                                                                                <button onClick={cancelEdit} className="px-4 py-2 bg-gray-300 rounded">Cancel</button>
                                                                            </div>
                                                                        </div>
                                                                    ) : (
                                                                        <div className="flex justify-between items-start">
                                                                            <div className="flex-1">
                                                                                <div className="flex items-center gap-2">
                                                                                    <button onClick={() => toggleActivityExpanded(a.id)} className="text-gray-500 hover:text-gray-700">
                                                                                        {isExpanded ? '▼' : '▶'}
                                                                                    </button>
                                                                                    <div>
                                                                                        <h3 className="font-bold">
                                                                                            {a.notify && '🔔 '}{a.title} - <span style={{ color: kid?.color }}>{kid?.name}</span>
                                                                                            {a.prepTasks?.length > 0 && <span className="ml-2 text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">+{a.prepTasks.length} tasks</span>}
                                                                                        </h3>
                                                                                        <p className="text-sm text-gray-600">{a.date} {a.time} | {a.type} | {a.parent}</p>
                                                                                        
                                                                                        {isExpanded && (
                                                                                            <div className="mt-2 p-3 bg-white rounded text-sm">
                                                                                                <p><strong>Location:</strong> {a.location || 'Not specified'}</p>
                                                                                                <p><strong>Category:</strong> {a.activityCategory || 'Other'}</p>
                                                                                                {a.notes && <p><strong>Notes:</strong> {a.notes}</p>}
                                                                                                {a.prepTasks?.length > 0 && (
                                                                                                    <div className="mt-2">
                                                                                                        <p className="font-semibold mb-1">Prep Tasks:</p>
                                                                                                        <ul className="list-disc ml-5">
                                                                                                            {a.prepTasks.map((task, idx) => <li key={idx}>{task}</li>)}
                                                                                                        </ul>
                                                                                                    </div>
                                                                                                )}
                                                                                            </div>
                                                                                        )}
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                            <div className="flex gap-2">
                                                                                <button onClick={() => startEdit(a)} className="text-blue-500 text-xl hover:text-blue-700" title="Edit">✏️</button>
                                                                                <button onClick={() => delAct(a.id)} className="text-red-500 text-xl hover:text-red-700" title="Delete">×</button>
                                                                            </div>
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            );
                                                        })}
                                                </div>
                                            ) : (
                                                // Grouped view (existing code for kid/date/parent grouping)
                                                <div className="space-y-4">
                                                    {(() => {
                                                        const filteredActs = acts.filter(a => showPast || a.date >= new Date().toISOString().split('T')[0]);
                                                        let groups = {};
                                                        
                                                        if (groupBy === 'kid') {
                                                            kids.forEach(k => {
                                                                groups[k.id] = { name: k.name, color: k.color, activities: filteredActs.filter(a => a.kidId === k.id) };
                                                            });
                                                        } else if (groupBy === 'date') {
                                                            filteredActs.forEach(a => {
                                                                if (!groups[a.date]) groups[a.date] = { name: a.date, activities: [] };
                                                                groups[a.date].activities.push(a);
                                                            });
                                                        } else if (groupBy === 'parent') {
                                                            ['Mom', 'Dad', 'Both'].forEach(p => {
                                                                groups[p] = { name: p, activities: filteredActs.filter(a => a.parent === p) };
                                                            });
                                                        }

                                                        return Object.entries(groups).map(([key, group]) => {
                                                            const isExpanded = expandedGroups[key] !== false;
                                                            
                                                            return (
                                                                <div key={key} className="border-2 rounded-lg" style={groupBy === 'kid' ? { borderColor: group.color } : {}}>
                                                                    <button 
                                                                        onClick={() => setExpandedGroups({ ...expandedGroups, [key]: !isExpanded })}
                                                                        className="w-full p-4 flex justify-between items-center font-bold text-lg"
                                                                    >
                                                                        <span style={groupBy === 'kid' ? { color: group.color } : {}}>
                                                                            {group.name} ({group.activities.length})
                                                                        </span>
                                                                        <span>{isExpanded ? '▼' : '▶'}</span>
                                                                    </button>
                                                                    
                                                                    {isExpanded && (
                                                                        <div className="p-4 pt-0 space-y-3">
                                                                            {group.activities.sort((a, b) => a.date.localeCompare(b.date) || (a.time || '').localeCompare(b.time || '')).map(a => {
                                                                                const kid = kids.find(k => k.id === a.kidId);
                                                                                const isExpanded = expandedActivities[a.id];
                                                                                
                                                                                return (
                                                                                    <div key={a.id} className="p-4 bg-gray-50 rounded-lg">
                                                                                        {editAct?.id === a.id ? (
                                                                                            <div className="space-y-2">
                                                                                                <div className="grid grid-cols-3 gap-2">
                                                                                                    <input value={editAct.title} onChange={e => setEditAct({ ...editAct, title: e.target.value })} placeholder="Activity" className="px-4 py-2 border rounded" />
                                                                                                    <input type="date" value={editAct.date} onChange={e => setEditAct({ ...editAct, date: e.target.value })} className="px-4 py-2 border rounded" />
                                                                                                    <input type="time" value={editAct.time} onChange={e => setEditAct({ ...editAct, time: e.target.value })} className="px-4 py-2 border rounded" />
                                                                                                    <input value={editAct.location} onChange={e => setEditAct({ ...editAct, location: e.target.value })} placeholder="Location" className="px-4 py-2 border rounded" />
                                                                                                    <select value={editAct.parent} onChange={e => setEditAct({ ...editAct, parent: e.target.value })} className="px-4 py-2 border rounded">
                                                                                                        <option>Mom</option>
                                                                                                        <option>Dad</option>
                                                                                                        <option>Both</option>
                                                                                                    </select>
                                                                                                    <select value={editAct.type} onChange={e => setEditAct({ ...editAct, type: e.target.value })} className="px-4 py-2 border rounded">
                                                                                                        <option>Pick Up</option>
                                                                                                        <option>Drop Off</option>
                                                                                                        <option>Other</option>
                                                                                                    </select>
                                                                                                    <select value={editAct.activityCategory} onChange={e => setEditAct({ ...editAct, activityCategory: e.target.value })} className="px-4 py-2 border rounded">
                                                                                                        <option>Physical</option>
                                                                                                        <option>Social</option>
                                                                                                        <option>Creative</option>
                                                                                                        <option>Academic</option>
                                                                                                        <option>Other</option>
                                                                                                    </select>
                                                                                                </div>
                                                                                                <textarea value={editAct.notes} onChange={e => setEditAct({ ...editAct, notes: e.target.value })} placeholder="Notes" className="w-full px-4 py-2 border rounded" rows="2" />
                                                                                                <div className="flex gap-2">
                                                                                                    <button onClick={saveEdit} className="px-4 py-2 bg-green-500 text-white rounded">💾 Save</button>
                                                                                                    <button onClick={cancelEdit} className="px-4 py-2 bg-gray-300 rounded">Cancel</button>
                                                                                                </div>
                                                                                            </div>
                                                                                        ) : (
                                                                                            <div className="flex justify-between items-start">
                                                                                                <div className="flex-1">
                                                                                                    <div className="flex items-center gap-2">
                                                                                                        <button onClick={() => toggleActivityExpanded(a.id)} className="text-gray-500 hover:text-gray-700">
                                                                                                            {isExpanded ? '▼' : '▶'}
                                                                                                        </button>
                                                                                                        <div>
                                                                                                            <h3 className="font-bold">
                                                                                                                {a.notify && '🔔 '}{a.title} - <span style={{ color: kid?.color }}>{kid?.name}</span>
                                                                                                                {a.prepTasks?.length > 0 && <span className="ml-2 text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">+{a.prepTasks.length} tasks</span>}
                                                                                                            </h3>
                                                                                                            <p className="text-sm text-gray-600">{a.date} {a.time} | {a.type} | {a.parent}</p>
                                                                                                            
                                                                                                            {isExpanded && (
                                                                                                                <div className="mt-2 p-3 bg-white rounded text-sm">
                                                                                                                    <p><strong>Location:</strong> {a.location || 'Not specified'}</p>
                                                                                                                    <p><strong>Category:</strong> {a.activityCategory || 'Other'}</p>
                                                                                                                    <p><strong>Created by:</strong> {a.createdBy || 'Unknown'}</p>
                                                                                                                    {a.notes && <p><strong>Notes:</strong> {a.notes}</p>}
                                                                                                                    {a.prepTasks?.length > 0 && (
                                                                                                                        <div className="mt-2">
                                                                                                                            <p className="font-semibold mb-1">Prep Tasks:</p>
                                                                                                                            <ul className="list-disc ml-5">
                                                                                                                                {a.prepTasks.map((task, idx) => <li key={idx}>{task}</li>)}
                                                                                                                            </ul>
                                                                                                                        </div>
                                                                                                                    )}
                                                                                                                </div>
                                                                                                            )}
                                                                                                        </div>
                                                                                                    </div>
                                                                                                </div>
                                                                                                <div className="flex gap-2">
                                                                                                    <button onClick={() => startEdit(a)} className="text-blue-500 text-xl hover:text-blue-700" title="Edit">✏️</button>
                                                                                                    <button onClick={() => delAct(a.id)} className="text-red-500 text-xl hover:text-red-700" title="Delete">×</button>
                                                                                                </div>
                                                                                            </div>
                                                                                        )}
                                                                                    </div>
                                                                                );
                                                                            })}
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            );
                                                        });
                                                    })()}
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
