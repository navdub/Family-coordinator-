<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Activity Coordinator</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        firebase.initializeApp({
            apiKey: "AIzaSyCsjCSABxbzg7c16g_kaP_TjiJkmwprTdM",
            authDomain: "family-activity-tracker-8c417.firebaseapp.com",
            projectId: "family-activity-tracker-8c417",
            storageBucket: "family-activity-tracker-8c417.firebasestorage.app",
            messagingSenderId: "434971947503",
            appId: "1:434971947503:web:aa2d53068d9be28082861a"
        });
        const db = firebase.firestore();

        function LoginScreen({ onLogin }) {
            const [code, setCode] = useState('');
            const [name, setName] = useState('');
            const [isNew, setIsNew] = useState(false);
            const [err, setErr] = useState('');

            const login = async () => {
                if (!code) return setErr('Enter code');
                try {
                    const doc = await db.collection('families').doc(code.toUpperCase()).get();
                    if (doc.exists) onLogin(code.toUpperCase(), doc.data().name);
                    else setErr('Code not found');
                } catch (e) { setErr('Error: ' + e.message); }
            };

            const create = async () => {
                if (!name) return setErr('Enter name');
                const newCode = Math.random().toString(36).substring(2, 10).toUpperCase();
                try {
                    await db.collection('families').doc(newCode).set({ name, createdAt: new Date() });
                    onLogin(newCode, name);
                } catch (e) { setErr('Error: ' + e.message); }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                        <h1 className="text-3xl font-bold text-center mb-6">Family Activity Tracker</h1>
                        {err && <div className="bg-red-100 text-red-700 p-3 rounded mb-4">{err}</div>}
                        {!isNew ? (
                            <>
                                <input value={code} onChange={e => setCode(e.target.value.toUpperCase())} placeholder="Family Code" className="w-full px-4 py-3 border rounded-lg mb-4 uppercase" />
                                <button onClick={login} className="w-full bg-purple-600 text-white py-3 rounded-lg mb-3">Login</button>
                                <button onClick={() => setIsNew(true)} className="text-purple-600">Create Family ‚Üí</button>
                            </>
                        ) : (
                            <>
                                <input value={name} onChange={e => setName(e.target.value)} placeholder="Family Name" className="w-full px-4 py-3 border rounded-lg mb-4" />
                                <button onClick={create} className="w-full bg-green-600 text-white py-3 rounded-lg mb-3">Create</button>
                                <button onClick={() => setIsNew(false)} className="text-gray-600">‚Üê Back</button>
                            </>
                        )}
                    </div>
                </div>
            );
        }

        function App() {
            const [code, setCode] = useState(localStorage.getItem('familyCode'));
            const [name, setName] = useState(localStorage.getItem('familyName'));
            const [kids, setKids] = useState([]);
            const [acts, setActs] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showKid, setShowKid] = useState(false);
            const [showAct, setShowAct] = useState(false);
            const [showCode, setShowCode] = useState(false);
            const [showPast, setShowPast] = useState(false);
            const [view, setView] = useState('list');
            const [groupBy, setGroupBy] = useState('none');
            const [expandedGroups, setExpandedGroups] = useState({});
            const [newKid, setNewKid] = useState({ name: '', color: '#4ECDC4' });
            const [newAct, setNewAct] = useState({ 
                kidId: '', 
                title: '', 
                date: '', 
                time: '', 
                location: '', 
                parent: 'Mom', 
                notes: '', 
                duration: 60,
                type: 'Pick Up',
                notify: false,
                recurring: 'none'
            });
            const colors = ['#FF6B9D', '#4ECDC4', '#95E1D3', '#F38181', '#AA96DA'];

            const handleLogin = (c, n) => {
                setCode(c);
                setName(n);
                localStorage.setItem('familyCode', c);
                localStorage.setItem('familyName', n);
            };

            const logout = () => {
                localStorage.clear();
                setCode(null);
            };

            useEffect(() => {
                if (!code) return setLoading(false);
                
                const unsub1 = db.collection('kids').where('familyCode', '==', code).onSnapshot(s => {
                    setKids(s.docs.map(d => ({ id: d.id, ...d.data() })));
                    setLoading(false);
                });
                
                const unsub2 = db.collection('activities').where('familyCode', '==', code).onSnapshot(s => {
                    setActs(s.docs.map(d => ({ id: d.id, ...d.data() })));
                });

                // Check notifications
                const interval = setInterval(() => {
                    const now = new Date();
                    acts.forEach(a => {
                        if (!a.notify || !a.time) return;
                        const actTime = new Date(`${a.date}T${a.time}`);
                        const diff = actTime - now;
                        if (diff > 1740000 && diff < 1800000) {
                            const kid = kids.find(k => k.id === a.kidId);
                            if ('Notification' in window && Notification.permission === 'granted') {
                                new Notification(`Upcoming: ${a.title}`, {
                                    body: `${kid?.name} - ${a.type} in 30 min at ${a.location}`
                                });
                            }
                        }
                    });
                }, 60000);

                return () => { unsub1(); unsub2(); clearInterval(interval); };
            }, [code, acts, kids]);

            const addKid = async () => {
                if (!newKid.name) return;
                await db.collection('kids').add({ ...newKid, familyCode: code });
                setNewKid({ name: '', color: '#4ECDC4' });
                setShowKid(false);
            };

            const delKid = async (id) => {
                if (!confirm('Delete?')) return;
                await db.collection('kids').doc(id).delete();
                const snap = await db.collection('activities').where('kidId', '==', id).get();
                snap.forEach(d => d.ref.delete());
            };

            const addAct = async () => {
                if (!newAct.title || !newAct.kidId || !newAct.date) return;

                if (newAct.recurring !== 'none') {
                    const startDate = new Date(newAct.date);
                    const interval = newAct.recurring === 'daily' ? 1 : newAct.recurring === 'weekly' ? 7 : 14;
                    const count = newAct.recurring === 'daily' ? 30 : 12;

                    for (let i = 0; i < count; i++) {
                        const d = new Date(startDate);
                        d.setDate(d.getDate() + (interval * i));
                        const dateStr = d.toISOString().split('T')[0];
                        await db.collection('activities').add({
                            ...newAct,
                            date: dateStr,
                            familyCode: code,
                            recurringId: Date.now()
                        });
                    }
                } else {
                    await db.collection('activities').add({ ...newAct, familyCode: code });
                }

                if (newAct.notify && 'Notification' in window) {
                    Notification.requestPermission();
                }

                setNewAct({ 
                    kidId: '', title: '', date: '', time: '', location: '', 
                    parent: 'Mom', notes: '', duration: 60, type: 'Pick Up',
                    notify: false, recurring: 'none'
                });
                setShowAct(false);
            };

            const delAct = async (id) => {
                if (!confirm('Delete?')) return;
                await db.collection('activities').doc(id).delete();
            };

            if (!code) return <LoginScreen onLogin={handleLogin} />;
            if (loading) return <div className="min-h-screen flex items-center justify-center"><div className="text-xl">Loading...</div></div>;

            const today = new Date().toISOString().split('T')[0];
            const upcoming = acts.filter(a => a.date >= today).sort((a, b) => a.date.localeCompare(b.date));
            const past = acts.filter(a => a.date < today).sort((a, b) => b.date.localeCompare(a.date));

            const toggleGroup = (groupName) => {
                setExpandedGroups(prev => ({ ...prev, [groupName]: !prev[groupName] }));
            };

            const groupActivities = (activities) => {
                if (groupBy === 'none') return { 'All': activities };
                
                const grouped = {};
                activities.forEach(a => {
                    let key;
                    if (groupBy === 'kid') {
                        const kid = kids.find(k => k.id === a.kidId);
                        key = kid?.name || 'Unknown';
                    } else if (groupBy === 'type') {
                        key = a.type || 'Other';
                    } else if (groupBy === 'parent') {
                        key = a.parent || 'Unknown';
                    } else if (groupBy === 'title') {
                        key = a.title;
                    }
                    if (!grouped[key]) grouped[key] = [];
                    grouped[key].push(a);
                });
                return grouped;
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 p-4">
                    <div className="max-w-6xl mx-auto bg-white rounded-2xl shadow-xl p-6">
                        <div className="flex justify-between items-center mb-6">
                            <h1 className="text-3xl font-bold">{name}</h1>
                            <div className="flex gap-2">
                                <button onClick={() => setShowCode(true)} className="px-4 py-2 bg-purple-100 rounded-lg">Share</button>
                                <button onClick={logout} className="px-4 py-2 bg-gray-100 rounded-lg">Logout</button>
                            </div>
                        </div>

                        {showCode && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                                <div className="bg-white rounded-2xl p-8 max-w-md">
                                    <h2 className="text-2xl font-bold mb-4">Family Code</h2>
                                    <div className="bg-purple-50 p-4 rounded-lg mb-4">
                                        <p className="text-3xl font-mono text-center text-purple-600">{code}</p>
                                    </div>
                                    <button onClick={() => { navigator.clipboard.writeText(code); alert('Copied!'); }} className="w-full bg-purple-600 text-white py-3 rounded-lg mb-2">Copy</button>
                                    <button onClick={() => setShowCode(false)} className="w-full bg-gray-200 py-3 rounded-lg">Close</button>
                                </div>
                            </div>
                        )}

                        <div className="mb-8">
                            <div className="flex justify-between mb-4">
                                <h2 className="text-xl font-bold">Kids</h2>
                                <button onClick={() => setShowKid(true)} className="px-4 py-2 bg-blue-500 text-white rounded-lg">+ Add</button>
                            </div>
                            <div className="flex gap-3 flex-wrap">
                                {kids.map(k => (
                                    <div key={k.id} className="flex items-center gap-2 px-4 py-2 rounded-full" style={{ backgroundColor: k.color + '30' }}>
                                        <span style={{ color: k.color }}>{k.name}</span>
                                        <button onClick={() => delKid(k.id)} className="text-red-500">√ó</button>
                                    </div>
                                ))}
                            </div>
                            {showKid && (
                                <div className="mt-4 p-4 bg-gray-50 rounded-lg">
                                    <input value={newKid.name} onChange={e => setNewKid({ ...newKid, name: e.target.value })} placeholder="Name" className="w-full px-4 py-2 border rounded mb-3" />
                                    <div className="flex gap-2 mb-3">
                                        {colors.map(c => (
                                            <button key={c} onClick={() => setNewKid({ ...newKid, color: c })} className="w-8 h-8 rounded-full" style={{ backgroundColor: c, border: newKid.color === c ? '2px solid black' : 'none' }} />
                                        ))}
                                    </div>
                                    <button onClick={addKid} className="px-4 py-2 bg-blue-500 text-white rounded mr-2">Add</button>
                                    <button onClick={() => setShowKid(false)} className="px-4 py-2 bg-gray-300 rounded">Cancel</button>
                                </div>
                            )}
                        </div>

                        <div>
                            <div className="flex justify-between mb-4 flex-wrap gap-2">
                                <h2 className="text-xl font-bold">Activities</h2>
                                <div className="flex gap-2 flex-wrap">
                                    {view === 'list' && (
                                        <select value={groupBy} onChange={e => setGroupBy(e.target.value)} className="px-3 py-2 border rounded bg-white">
                                            <option value="none">No Grouping</option>
                                            <option value="title">Group by Activity</option>
                                            <option value="kid">Group by Kid</option>
                                            <option value="type">Group by Type</option>
                                            <option value="parent">Group by Parent</option>
                                        </select>
                                    )}
                                    <button onClick={() => setView('list')} className={`px-3 py-2 rounded ${view === 'list' ? 'bg-green-500 text-white' : 'bg-gray-200'}`}>List</button>
                                    <button onClick={() => setView('calendar')} className={`px-3 py-2 rounded ${view === 'calendar' ? 'bg-green-500 text-white' : 'bg-gray-200'}`}>Calendar</button>
                                    <button onClick={() => setShowAct(true)} className="px-4 py-2 bg-green-500 text-white rounded-lg">+ Add</button>
                                </div>
                            </div>

                            {showAct && (
                                <div className="mb-4 p-4 bg-gray-50 rounded-lg">
                                    <select value={newAct.kidId} onChange={e => setNewAct({ ...newAct, kidId: e.target.value })} className="w-full px-4 py-2 border rounded mb-2">
                                        <option value="">Select Kid</option>
                                        {kids.map(k => <option key={k.id} value={k.id}>{k.name}</option>)}
                                    </select>
                                    <input value={newAct.title} onChange={e => setNewAct({ ...newAct, title: e.target.value })} placeholder="Activity" className="w-full px-4 py-2 border rounded mb-2" />
                                    <input type="date" value={newAct.date} onChange={e => setNewAct({ ...newAct, date: e.target.value })} className="w-full px-4 py-2 border rounded mb-2" />
                                    <input type="time" value={newAct.time} onChange={e => setNewAct({ ...newAct, time: e.target.value })} className="w-full px-4 py-2 border rounded mb-2" />
                                    <input value={newAct.location} onChange={e => setNewAct({ ...newAct, location: e.target.value })} placeholder="Location" className="w-full px-4 py-2 border rounded mb-2" />
                                    <select value={newAct.parent} onChange={e => setNewAct({ ...newAct, parent: e.target.value })} className="w-full px-4 py-2 border rounded mb-2">
                                        <option>Mom</option>
                                        <option>Dad</option>
                                        <option>Both</option>
                                    </select>
                                    <select value={newAct.type} onChange={e => setNewAct({ ...newAct, type: e.target.value })} className="w-full px-4 py-2 border rounded mb-2">
                                        <option>Pick Up</option>
                                        <option>Drop Off</option>
                                        <option>Other</option>
                                    </select>
                                    <select value={newAct.recurring} onChange={e => setNewAct({ ...newAct, recurring: e.target.value })} className="w-full px-4 py-2 border rounded mb-2">
                                        <option value="none">One-time</option>
                                        <option value="daily">Daily (30 days)</option>
                                        <option value="weekly">Weekly (12 weeks)</option>
                                        <option value="biweekly">Bi-weekly (12 times)</option>
                                    </select>
                                    <label className="flex items-center gap-2 mb-3 cursor-pointer">
                                        <input type="checkbox" checked={newAct.notify} onChange={e => setNewAct({ ...newAct, notify: e.target.checked })} className="w-5 h-5" />
                                        <span>üîî Notify 30 min before</span>
                                    </label>
                                    <textarea value={newAct.notes} onChange={e => setNewAct({ ...newAct, notes: e.target.value })} placeholder="Notes" className="w-full px-4 py-2 border rounded mb-2" rows="2"></textarea>
                                    <button onClick={addAct} className="px-4 py-2 bg-green-500 text-white rounded mr-2">Add</button>
                                    <button onClick={() => setShowAct(false)} className="px-4 py-2 bg-gray-300 rounded">Cancel</button>
                                </div>
                            )}

                            {view === 'calendar' ? (
                                <div className="grid grid-cols-7 gap-2">
                                    {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(d => (
                                        <div key={d} className="text-center font-bold p-2 bg-gray-100 rounded text-sm">{d}</div>
                                    ))}
                                    {(() => {
                                        const now = new Date();
                                        const year = now.getFullYear();
                                        const month = now.getMonth();
                                        const firstDay = new Date(year, month, 1).getDay();
                                        const daysInMonth = new Date(year, month + 1, 0).getDate();
                                        const days = [];
                                        
                                        for (let i = 0; i < firstDay; i++) {
                                            days.push(<div key={`e-${i}`} className="p-2 h-24 border rounded bg-gray-50"></div>);
                                        }
                                        
                                        for (let day = 1; day <= daysInMonth; day++) {
                                            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                                            const dayActs = acts.filter(a => a.date === dateStr);
                                            const isPast = dateStr < today;
                                            days.push(
                                                <div key={day} className={`p-2 h-24 border rounded overflow-y-auto ${isPast ? 'bg-gray-100' : 'bg-white'}`}>
                                                    <div className={`font-bold text-sm mb-1 ${isPast ? 'text-gray-400' : ''}`}>{day}</div>
                                                    {dayActs.map(a => {
                                                        const kid = kids.find(k => k.id === a.kidId);
                                                        return (
                                                            <div key={a.id} className={`text-xs p-1 mb-1 rounded ${isPast ? 'opacity-50' : ''}`} style={{ backgroundColor: kid?.color + '40', borderLeft: `2px solid ${kid?.color}` }}>
                                                                {a.notify && 'üîî '}{a.time} {a.title}
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            );
                                        }
                                        return days;
                                    })()}
                                </div>
                            ) : (
                                <div className="space-y-3">
                                    <h3 className="font-bold text-lg">Upcoming</h3>
                                    {upcoming.length === 0 ? <p className="text-gray-500 text-center py-4">No upcoming activities</p> : (() => {
                                        const grouped = groupActivities(upcoming);
                                        return Object.keys(grouped).map(groupName => {
                                            const groupActs = grouped[groupName];
                                            const isExpanded = expandedGroups[groupName] !== false;
                                            
                                            if (groupBy === 'none') {
                                                return groupActs.map(a => {
                                                    const kid = kids.find(k => k.id === a.kidId);
                                                    return (
                                                        <div key={a.id} className="p-4 border-l-4 rounded shadow bg-white" style={{ borderLeftColor: kid?.color }}>
                                                            <div className="flex justify-between">
                                                                <div>
                                                                    <h3 className="font-bold">
                                                                        {a.notify && 'üîî '}{a.title} - <span style={{ color: kid?.color }}>{kid?.name}</span>
                                                                        {a.recurringId && <span className="ml-2 text-xs bg-purple-100 px-2 py-1 rounded">Recurring</span>}
                                                                    </h3>
                                                                    <p className="text-sm text-gray-600">{a.date} {a.time} | {a.type} | {a.parent} | {a.location}</p>
                                                                    {a.notes && <p className="text-sm text-gray-500 mt-1">{a.notes}</p>}
                                                                </div>
                                                                <button onClick={() => delAct(a.id)} className="text-red-500 text-xl">√ó</button>
                                                            </div>
                                                        </div>
                                                    );
                                                });
                                            }
                                            
                                            return (
                                                <div key={groupName} className="border rounded-lg overflow-hidden">
                                                    <button
                                                        onClick={() => toggleGroup(groupName)}
                                                        className="w-full p-4 bg-gradient-to-r from-purple-50 to-blue-50 flex justify-between items-center hover:from-purple-100 hover:to-blue-100 transition"
                                                    >
                                                        <div className="flex items-center gap-3">
                                                            <span className="text-2xl">{isExpanded ? '‚ñº' : '‚ñ∂'}</span>
                                                            <div className="text-left">
                                                                <h3 className="font-bold text-lg">{groupName}</h3>
                                                                <p className="text-sm text-gray-600">{groupActs.length} {groupActs.length === 1 ? 'activity' : 'activities'}</p>
                                                            </div>
                                                        </div>
                                                    </button>
                                                    {isExpanded && (
                                                        <div className="p-2 space-y-2">
                                                            {groupActs.map(a => {
                                                                const kid = kids.find(k => k.id === a.kidId);
                                                                return (
                                                                    <div key={a.id} className="p-3 border-l-4 rounded bg-white shadow-sm" style={{ borderLeftColor: kid?.color }}>
                                                                        <div className="flex justify-between">
                                                                            <div>
                                                                                <h4 className="font-semibold">
                                                                                    {a.notify && 'üîî '}{a.title} - <span style={{ color: kid?.color }}>{kid?.name}</span>
                                                                                    {a.recurringId && <span className="ml-2 text-xs bg-purple-100 px-2 py-1 rounded">Recurring</span>}
                                                                                </h4>
                                                                                <p className="text-sm text-gray-600">{a.date} {a.time} | {a.type} | {a.parent} | {a.location}</p>
                                                                                {a.notes && <p className="text-sm text-gray-500 mt-1">{a.notes}</p>}
                                                                            </div>
                                                                            <button onClick={() => delAct(a.id)} className="text-red-500 text-xl">√ó</button>
                                                                        </div>
                                                                    </div>
                                                                );
                                                            })}
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        });
                                    })()}

                                    {past.length > 0 && (
                                        <div className="mt-6">
                                            <div className="flex justify-between items-center mb-2">
                                                <h3 className="font-bold text-lg text-gray-500">Past Activities</h3>
                                                <button onClick={() => setShowPast(!showPast)} className="text-sm text-purple-600">
                                                    {showPast ? 'Hide' : `Show (${past.length})`}
                                                </button>
                                            </div>
                                            {showPast && past.map(a => {
                                                const kid = kids.find(k => k.id === a.kidId);
                                                return (
                                                    <div key={a.id} className="p-4 border-l-4 rounded shadow bg-gray-50 opacity-60 mb-2" style={{ borderLeftColor: kid?.color }}>
                                                        <div className="flex justify-between">
                                                            <div>
                                                                <h3 className="font-bold text-gray-600">{a.title} - <span style={{ color: kid?.color }}>{kid?.name}</span></h3>
                                                                <p className="text-sm text-gray-500">{a.date} {a.time} | {a.type} | {a.parent}</p>
                                                            </div>
                                                            <button onClick={() => delAct(a.id)} className="text-red-400">√ó</button>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
